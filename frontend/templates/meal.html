{% extends "base.html" %}
{% block title %}Log a Meal ‚Äî Smart Nutrition{% endblock %}
{% block content %}
<div class="meal-container">
  <h2>üçΩÔ∏è Log a Meal</h2>
  <p class="muted">Record your food intake. Calories and nutrients are calculated automatically based on quantity.</p>

  <div class="meal-grid">
    <!-- Meal Form -->
    <div class="card form-card">
      <h3>Add Food Entry</h3>
      <form method="post" class="meal-form" id="mealForm">
        <div class="form-group">
          <label for="food_id">Select Food Item *</label>
          <select id="food_id" name="food_id" required onchange="updateNutritionInfo()">
            <option value="">-- Choose a food --</option>
            {% for f in foods %}
            <option value="{{ f.id }}" 
                    data-calories="{{ f.calories_per_100g }}"
                    data-protein="{{ f.protein_g }}"
                    data-carbs="{{ f.carbs_g }}"
                    data-fat="{{ f.fat_g }}">
              {{ f.name }}
            </option>
            {% endfor %}
          </select>
          <small class="help-text">Can't find your food? We're constantly adding more items!</small>
        </div>

        <div class="form-group">
          <label for="quantity_g">Quantity (grams) *</label>
          <input type="number" 
                 id="quantity_g"
                 name="quantity_g" 
                 step="1" 
                 min="1"
                 placeholder="e.g., 150" 
                 required
                 oninput="updateNutritionInfo()">
          <small class="help-text">Enter the weight of food consumed</small>
        </div>

        <div class="form-group">
          <label for="eaten_at">Date & Time</label>
          <input type="datetime-local" 
                 id="eaten_at"
                 name="eaten_at">
          <small class="help-text">Leave empty to use current time</small>
        </div>

        <!-- Nutrition Preview -->
        <div id="nutritionPreview" class="nutrition-preview" style="display: none;">
          <h4>üìä Nutrition Preview</h4>
          <div class="preview-grid">
            <div class="preview-item calories">
              <span class="preview-icon">üî•</span>
              <div>
                <span class="preview-value" id="previewCalories">0</span>
                <span class="preview-label">Calories</span>
              </div>
            </div>
            <div class="preview-item">
              <span class="preview-icon">ü•©</span>
              <div>
                <span class="preview-value" id="previewProtein">0g</span>
                <span class="preview-label">Protein</span>
              </div>
            </div>
            <div class="preview-item">
              <span class="preview-icon">üçû</span>
              <div>
                <span class="preview-value" id="previewCarbs">0g</span>
                <span class="preview-label">Carbs</span>
              </div>
            </div>
            <div class="preview-item">
              <span class="preview-icon">ü•ë</span>
              <div>
                <span class="preview-value" id="previewFat">0g</span>
                <span class="preview-label">Fat</span>
              </div>
            <!-- In meal.html, add these to the nutrition preview -->
            <div class="preview-item">
              <span class="preview-icon">üåæ</span>
              <div>
                <span class="preview-value" id="previewFiber">0g</span>
                <span class="preview-label">Fiber</span>
              </div>
            </div>
            <div class="preview-item">
              <span class="preview-icon">üç¨</span>
              <div>
                <span class="preview-value" id="previewSugar">0g</span>
                <span class="preview-label">Sugar</span>
              </div>
            </div>
            <div class="preview-item">
              <span class="preview-icon">üßÇ</span>
              <div>
                <span class="preview-value" id="previewSodium">0mg</span>
                <span class="preview-label">Sodium</span>
              </div>
            </div>
            </div>
          </div>
        </div>

        <button type="submit" class="btn-primary btn-large">‚úÖ Log This Meal</button>
      </form>
    </div>

    <!-- Quick Reference -->
    <div class="card reference-card">
      <h3>üìè Serving Size Reference</h3>
      <div class="reference-list" id="referenceList"></div>
    </div>
  </div>

  <!-- Tips Card -->
  <div class="card tips-card">
    <h3>üí° Meal Logging Tips</h3>
    <ul class="tips-list">
      <li><strong>Be consistent:</strong> Log your meals immediately after eating for best accuracy</li>
      <li><strong>Use a kitchen scale:</strong> Weighing food is more accurate than volume measurements</li>
      <li><strong>Don't forget snacks:</strong> Small snacks add up throughout the day</li>
      <li><strong>Log everything:</strong> Include cooking oils, condiments, and beverages</li>
      <li><strong>Review regularly:</strong> Check your reports page to spot patterns</li>
    </ul>
  </div>
</div>

<script>
function updateNutritionInfo() {
  const select = document.getElementById('food_id');
  const quantityInput = document.getElementById('quantity_g');
  const preview = document.getElementById('nutritionPreview');
  
  if (!select.value || !quantityInput.value) {
    preview.style.display = 'none';
    return;
  }
  
  const option = select.options[select.selectedIndex];
  const quantity = parseFloat(quantityInput.value);
  
  const calories = parseFloat(option.dataset.calories || 0);
  const protein = parseFloat(option.dataset.protein || 0);
  const carbs = parseFloat(option.dataset.carbs || 0);
  const fat = parseFloat(option.dataset.fat || 0);
  const fiber = parseFloat(option.dataset.fiber || 0);
  const sugar = parseFloat(option.dataset.sugar || 0);
  const sodium = parseFloat(option.dataset.sodium || 0);
  
  const factor = quantity / 100;
  
  document.getElementById('previewCalories').textContent = Math.round(calories * factor);
  document.getElementById('previewProtein').textContent = (protein * factor).toFixed(1) + 'g';
  document.getElementById('previewCarbs').textContent = (carbs * factor).toFixed(1) + 'g';
  document.getElementById('previewFat').textContent = (fat * factor).toFixed(1) + 'g';
  document.getElementById('previewFiber').textContent = (fiber * factor).toFixed(1) + 'g';
  document.getElementById('previewSugar').textContent = (sugar * factor).toFixed(1) + 'g';
  document.getElementById('previewSodium').textContent = (sodium * factor).toFixed(0) + 'mg';
  preview.style.display = 'block';
}

// Set current date-time as default
document.addEventListener('DOMContentLoaded', () => {
  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
  document.getElementById('eaten_at').value = now.toISOString().slice(0, 16);
});

// Smart Food Search
let searchTimeout;
const foodSelect = document.getElementById('food_id');

// Create search input
const searchInput = document.createElement('input');
searchInput.type = 'text';
searchInput.id = 'smart_search';
searchInput.placeholder = 'Search foods... (e.g., chkn, dal, bana)';
searchInput.className = 'form-input';

// Insert search input before the select
foodSelect.parentNode.insertBefore(searchInput, foodSelect);

// Hide select initially
foodSelect.style.display = 'none';

// Create results container
const resultsDiv = document.createElement('div');
resultsDiv.id = 'search_results';
resultsDiv.className = 'search-results';
searchInput.parentNode.insertBefore(resultsDiv, foodSelect);

searchInput.addEventListener('input', function() {
  clearTimeout(searchTimeout);
  const query = this.value.trim();
  
  if (query.length < 2) {
    resultsDiv.innerHTML = '';
    return;
  }
  
  searchTimeout = setTimeout(async () => {
    try {
      const response = await fetch(`/api/ml-smart-search?q=${encodeURIComponent(query)}`);
      const results = await response.json();
      
      if (results.length === 0) {
        resultsDiv.innerHTML = '<div class="search-empty">No foods found</div>';
        return;
      }
      
      let html = '<div class="search-results-list">';
      results.forEach(result => {
        const food = result.food;
        const matchBadge = result.match_reason === 'exact' ? '‚úì' : 
                          result.match_reason === 'starts_with' ? '‚Üí' : '~';
        html += `
          <div class="search-result-item" onclick="selectFood(${food.id}, '${food.name}')">
            <div class="result-name">
              <span class="match-badge">${matchBadge}</span>
              ${food.name}
            </div>
            <div class="result-nutrition">
              ${food.calories_per_100g} kcal/100g
            </div>
          </div>
        `;
      });
      html += '</div>';
      resultsDiv.innerHTML = html;
    } catch (error) {
      console.error('Search error:', error);
    }
  }, 300);
});

// Function to select food from search results
window.selectFood = function(foodId, foodName) {
  foodSelect.value = foodId;
  searchInput.value = foodName;
  resultsDiv.innerHTML = '';
  updateNutritionInfo();
};

document.addEventListener("DOMContentLoaded", async () => {
  const refList = document.getElementById("referenceList");

  // Base data (sample from Kaggle Indian Food Nutrition dataset)
  const baseItems = [
    { name: "Rice (Cooked)", size: "1 cup ‚âà 200g" },
    { name: "Dal (Cooked)", size: "1 cup ‚âà 200g" },
    { name: "Chapati/Roti", size: "1 piece ‚âà 45g" },
    { name: "Paneer", size: "1 cube ‚âà 30g" },
    { name: "Dosa", size: "1 piece ‚âà 100g" },
    { name: "Idli", size: "1 piece ‚âà 50g" },
    { name: "Sambar", size: "1 bowl ‚âà 150g" },
    { name: "Upma", size: "1 cup ‚âà 180g" },
    { name: "Poha", size: "1 cup ‚âà 150g" },
    { name: "Biryani", size: "1 plate ‚âà 300g" },
    { name: "Aloo Paratha", size: "1 piece ‚âà 120g" },
    { name: "Curd", size: "1 cup ‚âà 200g" },
    { name: "Vegetable Curry", size: "1 bowl ‚âà 200g" },
    { name: "Fish Curry", size: "1 bowl ‚âà 180g" },
    { name: "Chicken Curry", size: "1 bowl ‚âà 200g" },
    { name: "Egg Curry", size: "1 bowl ‚âà 180g" },
    { name: "Rajma", size: "1 cup ‚âà 200g" },
    { name: "Chole", size: "1 cup ‚âà 200g" },
    { name: "Pulao", size: "1 cup ‚âà 180g" },
    { name: "Vegetable Sandwich", size: "1 piece ‚âà 150g" }
  ];

  // Make the list 5√ó longer
  let items = [];
  for (let i = 0; i < 5; i++) {
    items = items.concat(baseItems.map((item, idx) => ({
      name: item.name + (i > 0 ? ` (${i+1})` : ""),
      size: item.size
    })));
  }

  let loaded = 0;
  const batchSize = 10;

  // Function to load more items
  function loadMore() {
    const nextBatch = items.slice(loaded, loaded + batchSize);
    nextBatch.forEach(item => {
      const div = document.createElement("div");
      div.className = "reference-item";
      div.innerHTML = `<strong>${item.name}</strong><span>${item.size}</span>`;
      refList.appendChild(div);
    });
    loaded += batchSize;
  }

  // Initial load
  loadMore();

  // Infinite scroll
  refList.addEventListener("scroll", () => {
    if (refList.scrollTop + refList.clientHeight >= refList.scrollHeight - 10) {
      loadMore();
    }
  });
});
</script>

<style>
.meal-container {
  max-width: 1000px;
  margin: 0 auto;
}

.meal-grid {
  display: grid;
  grid-template-columns: 1.5fr 1fr;
  gap: 20px;
  margin: 20px 0;
}

.form-card {
  background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(247,250,252,0.95));
}

.meal-form .form-group {
  margin-bottom: 24px;
}

.meal-form label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: var(--text);
  font-size: 14px;
}

.meal-form input,
.meal-form select {
  width: 100%;
  padding: 12px 14px;
  border: 1px solid var(--border);
  border-radius: 10px;
  font-size: 15px;
  transition: all 0.2s ease;
  background: white;
}

.meal-form input:focus,
.meal-form select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(79, 157, 246, 0.1);
}

.help-text {
  display: block;
  margin-top: 6px;
  font-size: 12px;
  color: var(--muted);
  font-style: italic;
}

.nutrition-preview {
  padding: 20px;
  background: linear-gradient(135deg, rgba(79, 157, 246, 0.08), rgba(34, 197, 94, 0.08));
  border-radius: 12px;
  margin: 24px 0;
  border: 2px solid rgba(79, 157, 246, 0.2);
}

.nutrition-preview h4 {
  margin: 0 0 14px;
  color: var(--text);
  font-size: 15px;
}

.preview-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}

.preview-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px;
  background: white;
  border-radius: 8px;
  border: 1px solid var(--border);
}

.preview-item.calories {
  grid-column: 1 / -1;
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), white);
}

.preview-icon {
  font-size: 24px;
}

.preview-value {
  display: block;
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
}

.preview-label {
  display: block;
  font-size: 11px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.btn-large {
  width: 100%;
  padding: 14px 28px;
  font-size: 16px;
  margin-top: 8px;
}

.reference-card {
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.08), rgba(255, 255, 255, 0.95));
  height: fit-content;
}

.reference-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 16px;
}

.reference-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 12px;
  background: white;
  border-radius: 8px;
  border: 1px solid var(--border);
  font-size: 13px;
}

.reference-item strong {
  color: var(--text);
}

.reference-item span {
  color: var(--muted);
  font-weight: 600;
}

.tips-card {
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.08), rgba(255, 255, 255, 0.95));
  border-left: 4px solid var(--warn);
  margin-top: 20px;
}

.tips-list {
  margin-top: 12px;
  padding-left: 20px;
}

.tips-list li {
  margin-bottom: 10px;
  line-height: 1.6;
  color: var(--muted);
}

.tips-list strong {
  color: var(--text);
}

.search-results {
  margin: 8px 0;
}

.search-results-list {
  background: white;
  border: 1px solid var(--border);
  border-radius: 8px;
  max-height: 300px;
  overflow-y: auto;
}

.search-result-item {
  padding: 12px 16px;
  cursor: pointer;
  border-bottom: 1px solid var(--border);
  transition: background 0.2s ease;
}

.search-result-item:last-child {
  border-bottom: none;
}

.search-result-item:hover {
  background: rgba(79, 157, 246, 0.08);
}

.result-name {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  margin-bottom: 4px;
}

.match-badge {
  display: inline-block;
  width: 20px;
  height: 20px;
  background: rgba(79, 157, 246, 0.15);
  border-radius: 4px;
  text-align: center;
  font-size: 12px;
  color: var(--primary);
}

.result-nutrition {
  font-size: 13px;
  color: var(--muted);
}

.search-empty {
  padding: 20px;
  text-align: center;
  color: var(--muted);
}

@media (max-width: 768px) {
  .meal-grid {
    grid-template-columns: 1fr;
  }
  
  .preview-grid {
    grid-template-columns: 1fr;
  }
  
  .preview-item.calories {
    grid-column: 1;
  }
}
</style>
{% endblock %}