{% extends "base.html" %}
{% block title %}Dashboard ‚Äî Smart Nutrition{% endblock %}
{% block content %}
<div class="dashboard-grid">
  <!-- Welcome Header -->
  <div class="welcome-card card">
    <h2>Welcome back, {{ user }}! üëã</h2>
    <p class="muted">Track your progress, log meals, and achieve your health goals.</p>
  </div>

  <!-- Quick Stats -->
  <div class="stats-grid">
    <div class="stat-card card">
      <div class="stat-icon bmi-icon">üìä</div>
      <div class="stat-content">
        <p class="stat-label">Current BMI</p>
        <p class="stat-value">{{ bio.bmi if bio else '‚Äî' }}</p>
        {% if bio %}
        <p class="stat-subtitle">
          {% if bio.bmi < 18.5 %}Underweight
          {% elif bio.bmi < 25 %}Normal
          {% elif bio.bmi < 30 %}Overweight
          {% else %}Obese
          {% endif %}
        </p>
        {% endif %}
      </div>
    </div>

    <div class="stat-card card">
      <div class="stat-icon calorie-icon">üî•</div>
      <div class="stat-content">
        <p class="stat-label">Today's Calories</p>
        <p class="stat-value">{{ today_calories.total|round|int if today_calories else 0 }}</p>
        <p class="stat-subtitle">kcal consumed</p>
      </div>
    </div>

    <div class="stat-card card">
      <div class="stat-icon goal-icon">üéØ</div>
      <div class="stat-content">
        <p class="stat-label">Current Goal</p>
        <p class="stat-value">
          {% if bio %}
            {% if bio.goal == 'loss' %}Lose Weight
            {% elif bio.goal == 'gain' %}Gain Weight
            {% else %}Maintain
            {% endif %}
          {% else %}‚Äî{% endif %}
        </p>
        <p class="stat-subtitle">{{ bio.weight_kg if bio else '‚Äî' }} kg</p>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="card">
    <h3>Quick Actions</h3>
    <div class="action-grid">
      <a href="/meal" class="action-button">
        <span class="action-icon">üçΩÔ∏è</span>
        <span class="action-text">
          <strong>Log Meal</strong>
          <small>Record your food intake</small>
        </span>
      </a>
      
      <a href="/profile" class="action-button">
        <span class="action-icon">üë§</span>
        <span class="action-text">
          <strong>Update Profile</strong>
          <small>Manage personal info & biometrics</small>
        </span>
      </a>
      
      <a href="/progress" class="action-button">
        <span class="action-icon">üìà</span>
        <span class="action-text">
          <strong>View Progress</strong>
          <small>Charts & predictions</small>
        </span>
      </a>
      
      <a href="/reports" class="action-button">
        <span class="action-icon">üìã</span>
        <span class="action-text">
          <strong>Reports</strong>
          <small>Detailed insights</small>
        </span>
      </a>
    </div>
  </div>

  <!-- Health Tips -->
  <div class="card tips-card">
    <h3>üí° Today's Health Tip</h3>
    {% if bio and bio.goal == 'loss' %}
    <p>To lose weight healthily, aim for a calorie deficit of 500-750 kcal per day. This typically results in 0.5-1 kg weight loss per week.</p>
    {% elif bio and bio.goal == 'gain' %}
    <p>To gain weight healthily, aim for a calorie surplus of 300-500 kcal per day. Focus on nutrient-dense foods and strength training.</p>
    {% else %}
    <p>Maintaining a balanced diet with adequate protein, healthy fats, and complex carbohydrates supports overall health and energy levels.</p>
    {% endif %}
  </div>

  <!-- Understanding BMI -->
  <div class="card bmi-info-card">
    <h3>üìö Understanding BMI</h3>
    <div class="bmi-ranges">
      <div class="bmi-range underweight">
        <span class="range-label">Underweight</span>
        <span class="range-value">&lt; 18.5</span>
      </div>
      <div class="bmi-range normal">
        <span class="range-label">Normal</span>
        <span class="range-value">18.5 - 24.9</span>
      </div>
      <div class="bmi-range overweight">
        <span class="range-label">Overweight</span>
        <span class="range-value">25.0 - 29.9</span>
      </div>
      <div class="bmi-range obese">
        <span class="range-label">Obese</span>
        <span class="range-value">‚â• 30.0</span>
      </div>
    </div>
    <p class="info-note">
      <strong>Note:</strong> BMI is a screening tool. It doesn't directly measure body fat and may not be accurate for athletes, elderly, or pregnant individuals. Consult healthcare professionals for personalized advice.
    </p>
  </div>
</div>

<!-- ML Insights Preview -->
<div class="card ml-preview-card">
  <div class="card-header">
    <h3>ü§ñ AI Insights</h3>
    <p class="muted">Quick preview of your health analysis</p>
  </div>
  <div id="mlPreview">
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading insights...</p>
    </div>
  </div>
  <div style="text-align: center; margin-top: 20px;">
    <a href="/ml-insights" class="btn-primary">View Full AI Insights ‚Üí</a>
  </div>
</div>

<script>
// Load ML preview
async function loadMLPreview() {
  try {
    const [scoreRes, patternsRes] = await Promise.all([
      fetch('/api/ml-nutrition-score'),
      fetch('/api/ml-eating-patterns')
    ]);
    
    const scoreData = await scoreRes.json();
    const patternsData = await patternsRes.json();
    
    let html = '<div class="ml-preview-grid">';
    
    // Nutrition Score
    if (!scoreData.error) {
      const scoreClass = scoreData.total_score >= 80 ? 'excellent' : 
                         scoreData.total_score >= 60 ? 'good' : 
                         scoreData.total_score >= 40 ? 'fair' : 'poor';
      html += `
        <div class="preview-item">
          <div class="preview-icon">üìä</div>
          <div class="preview-content">
            <h4>Nutrition Score</h4>
            <div class="preview-value ${scoreClass}">${scoreData.total_score}/100</div>
            <p class="preview-label">${scoreData.rating}</p>
          </div>
        </div>
      `;
    }
    
    // Eating Patterns
    if (!patternsData.error) {
      html += `
        <div class="preview-item">
          <div class="preview-icon">üïê</div>
          <div class="preview-content">
            <h4>Peak Eating Time</h4>
            <div class="preview-value">${patternsData.peak_eating_hours[0]}</div>
            <p class="preview-label">Most active hour</p>
          </div>
        </div>
        
        <div class="preview-item">
          <div class="preview-icon">üìà</div>
          <div class="preview-content">
            <h4>Consistency</h4>
            <div class="preview-value">${patternsData.consistency_score}%</div>
            <p class="preview-label">${patternsData.consistency.toUpperCase()}</p>
          </div>
        </div>
      `;
    }
    
    html += '</div>';
    document.getElementById('mlPreview').innerHTML = html;
  } catch (error) {
    document.getElementById('mlPreview').innerHTML = 
      '<div class="empty-state"><p class="muted">Unable to load insights</p></div>';
  }
}

if (document.getElementById('mlPreview')) {
  loadMLPreview();
}
</script>

<style>
.ml-preview-card {
  background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(79, 157, 246, 0.08));
  border-left: 4px solid rgb(139, 92, 246);
}

.ml-preview-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

.preview-item {
  padding: 20px;
  background: white;
  border-radius: 12px;
  text-align: center;
}

.preview-icon {
  font-size: 32px;
  margin-bottom: 8px;
}

.preview-content h4 {
  margin: 0 0 8px;
  font-size: 14px;
  color: var(--muted);
}

.preview-value {
  font-size: 32px;
  font-weight: 800;
  margin-bottom: 4px;
}

.preview-value.excellent { color: #22c55e; }
.preview-value.good { color: #4f9df6; }
.preview-value.fair { color: #f59e0b; }
.preview-value.poor { color: #ef4444; }

.preview-label {
  font-size: 12px;
  color: var(--muted);
  margin: 0;
}

.dashboard-grid {
  display: grid;
  gap: 20px;
  max-width: 1200px;
  margin: 0 auto;
}

.welcome-card {
  text-align: center;
  padding: 30px;
  background: linear-gradient(135deg, rgba(79,157,246,0.1), rgba(34,197,94,0.1));
}

.welcome-card h2 {
  margin: 0 0 10px;
  font-size: 28px;
  color: var(--text);
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

.stat-card {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px;
  transition: transform 0.2s ease;
}

.stat-card:hover {
  transform: translateY(-4px);
}

.stat-icon {
  font-size: 36px;
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
  background: linear-gradient(135deg, rgba(79,157,246,0.15), rgba(79,157,246,0.05));
}

.stat-content {
  flex: 1;
}

.stat-label {
  margin: 0;
  font-size: 13px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.stat-value {
  margin: 4px 0;
  font-size: 28px;
  font-weight: 700;
  color: var(--text);
}

.stat-subtitle {
  margin: 0;
  font-size: 13px;
  color: var(--muted);
}

.action-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 12px;
  margin-top: 16px;
}

.action-button {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px;
  background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(247,250,252,0.9));
  border: 1px solid var(--border);
  border-radius: 12px;
  text-decoration: none;
  color: var(--text);
  transition: all 0.2s ease;
}

.action-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.08);
  border-color: var(--primary);
}

.action-icon {
  font-size: 32px;
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, rgba(79,157,246,0.1), rgba(34,197,94,0.1));
  border-radius: 10px;
}

.action-text {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.action-text strong {
  font-size: 15px;
  color: var(--text);
}

.action-text small {
  font-size: 13px;
  color: var(--muted);
}

.tips-card {
  background: linear-gradient(135deg, rgba(245,158,11,0.08), rgba(34,197,94,0.08));
  border-left: 4px solid var(--accent);
}

.bmi-info-card {
  background: linear-gradient(135deg, rgba(79,157,246,0.08), rgba(255,255,255,0.95));
  border-left: 4px solid var(--primary);
}

.bmi-ranges {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 12px;
  margin: 16px 0 20px;
}

.bmi-range {
  padding: 14px;
  border-radius: 10px;
  text-align: center;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.bmi-range.underweight {
  background: #fef3c7;
  border: 2px solid #fbbf24;
}

.bmi-range.normal {
  background: #d1fae5;
  border: 2px solid #22c55e;
}

.bmi-range.overweight {
  background: #fed7aa;
  border: 2px solid #f97316;
}

.bmi-range.obese {
  background: #fecaca;
  border: 2px solid #ef4444;
}

.range-label {
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.range-value {
  font-size: 16px;
  font-weight: 700;
}

.info-note {
  padding: 14px;
  background: rgba(255, 255, 255, 0.6);
  border-radius: 8px;
  font-size: 13px;
  line-height: 1.6;
  color: var(--muted);
}

.info-note strong {
  color: var(--text);
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .action-grid {
    grid-template-columns: 1fr;
  }
  
  .bmi-ranges {
    grid-template-columns: 1fr 1fr;
  }
}
</style>
{% endblock %}